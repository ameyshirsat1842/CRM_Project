{% extends 'base.html' %}

{% block content %}
{% if user.is_authenticated %}
    <!-- Main Content -->
    <div class="container main-content">
        <h1 class="dashboard-heading">{{ user.first_name }}'s Dashboard</h1>
        <br>

        <!-- Meetings Today -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm card-highlight border-primary animate__animated animate__fadeIn" style="background-color: #b2ebf2;">
                    <div class="card-body">
                        <h5 class="card-title dashboard-title">
                            <i class="fas fa-calendar-day"></i> Meetings Today
                            <span class="badge bg-secondary float-end">{{ meetings_today|length }}</span>
                        </h5>
                        <ul class="list-group list-group-flush" id="meetingsToday">
                            {% for meeting in meetings_today %}
                                <li class="list-group-item d-flex justify-content-between align-items-center dashboard-text">
                                    <div>
                                        <strong>{{ meeting.client_name }}</strong> from <em>{{ meeting.company }}</em>
                                        <span class="text-muted">on {{ meeting.follow_up_date|date:"F d, Y" }}</span>
                                    </div>
                                    <button class="btn btn-primary btn-sm" onclick="openModal('{{ meeting.client_name }}', 'https://us05web.zoom.us/s/83827104906#success')">Join Zoom</button>
                                </li>
                            {% empty %}
                                <li class="list-group-item dashboard-text">No meetings scheduled for today.</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upcoming Meetings -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm card-highlight border-info animate__animated animate__fadeIn" style="background-color: #80cbc4;">
                    <div class="card-body">
                        <h5 class="card-title dashboard-title">
                            <i class="fas fa-calendar-alt"></i> Upcoming Meetings
                            <span class="badge bg-secondary float-end">{{ upcoming_meetings|length }}</span>
                        </h5>
                        <ul class="list-group list-group-flush" id="upcomingMeetings">
                            {% for meeting in upcoming_meetings %}
                                <li class="list-group-item d-flex justify-content-between align-items-center dashboard-text">
                                    <div>
                                        <strong>{{ meeting.client_name }}</strong> from <em>{{ meeting.company }}</em>
                                        <span class="text-muted">on {{ meeting.follow_up_date|date:"F d, Y" }}</span>
                                    </div>
                                    <button class="btn btn-outline-primary btn-sm" onclick="openModal('{{ meeting.client_name }}', 'https://outlook.live.com/calendar/0/view/month')">Open in Outlook</button>
                                </li>
                            {% empty %}
                                <li class="list-group-item dashboard-text">No upcoming meetings.</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Key Metrics -->
        <div class="row mb-4">
            <div class="col-6 col-md-3 mb-3 mb-md-0">
                <div class="card shadow-lg interactive-card card-gradient-leads border-success animate__animated animate__zoomIn" data-bs-toggle="tooltip" data-bs-placement="top" title="Total number of leads assigned to you" style="background-color: #aed581;">
                    <div class="card-body text-center">
                        <h5 class="card-title dashboard-title"><i class="fas fa-user-plus"></i> My Total Leads</h5>
                        <p class="card-text display-4 dashboard-metric" id="totalLeads">{{ total_leads }}</p>
                        <canvas id="leadsChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3 mb-3 mb-md-0">
                <div class="card shadow-lg interactive-card card-gradient-clients border-info animate__animated animate__zoomIn" data-bs-toggle="tooltip" data-bs-placement="top" title="Total number of clients managed by you" style="background-color: #64b5f6;">
                    <div class="card-body text-center">
                        <h5 class="card-title dashboard-title"><i class="fas fa-users"></i> My Total Clients</h5>
                        <p class="card-text display-4 dashboard-metric" id="totalClients">{{ total_clients }}</p>
                        <canvas id="clientsChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3 mb-3 mb-md-0">
                <div class="card shadow-lg interactive-card card-gradient-tickets border-warning animate__animated animate__zoomIn" data-bs-toggle="tooltip" data-bs-placement="top" title="Total number of open tickets assigned to you" style="background-color: #ffd54f;">
                    <div class="card-body text-center">
                        <h5 class="card-title dashboard-title"><i class="fas fa-ticket-alt"></i> My Open Tickets</h5>
                        <p class="card-text display-4 dashboard-metric" id="openTickets">{{ open_tickets }}</p>
                        <canvas id="ticketsChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3 mb-3 mb-md-0">
                <div class="card shadow-lg interactive-card card-gradient-overdues border-danger animate__animated animate__zoomIn" data-bs-toggle="tooltip" data-bs-placement="top" title="Total number of overdue tasks or activities" style="background-color: #ef9a9a;">
                    <div class="card-body text-center">
                        <h5 class="card-title dashboard-title"><i class="fas fa-exclamation-circle"></i> My Over Dues</h5>
                        <p class="card-text display-4 dashboard-metric" id="closedDeals">{{ closed_deals }}</p>
                        <canvas id="dealsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activities -->
        <div class="row mb-4">
            <div class="col-12 col-md-6 mb-3 mb-md-0">
                <div class="card shadow-lg card-highlight border-info animate__animated animate__fadeIn" style="background-color: #64b5f6;">
                    <div class="card-body">
                        <h5 class="card-title dashboard-title">
                            <i class="fas fa-user-plus"></i> Recent Leads Added (My Leads)
                            <span class="badge bg-secondary float-end">{{ recent_leads|length }}</span>
                        </h5>
                        <ul class="list-group list-group-flush" id="recentLeads">
                            {% for lead in recent_leads %}
                                <li class="list-group-item dashboard-text">
                                    <strong>{{ lead.client_name }}</strong>
                                    <span class="text-muted">- {{ lead.created_at|date:"F d, Y H:i" }}</span>
                                </li>
                            {% empty %}
                                <li class="list-group-item dashboard-text">No recent leads.</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-6 mb-3 mb-md-0">
                <div class="card shadow-lg card-highlight border-warning animate__animated animate__fadeIn" style="background-color: #ffe082;">
                    <div class="card-body">
                        <h5 class="card-title dashboard-title">
                            <i class="fas fa-ticket-alt"></i> Recent Tickets (My Tickets)
                            <span class="badge bg-secondary float-end">{{ recent_tickets|length }}</span>
                        </h5>
                        <ul class="list-group list-group-flush" id="recentTickets">
                            {% for ticket in recent_tickets %}
                                <li class="list-group-item dashboard-text">
                                    <strong>{{ ticket.title }}</strong>
                                    <span class="text-muted">- {{ ticket.created_at|date:"F d, Y H:i" }}</span>
                                </li>
                            {% empty %}
                                <li class="list-group-item dashboard-text">No recent tickets.</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Meeting Modal -->
    <div class="modal fade" id="meetingModal" tabindex="-1" aria-labelledby="meetingModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="meetingModalLabel">Meeting Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="meetingDetails"></p>
                </div>
                <div class="modal-footer">
                    <a href="#" id="meetingLink" class="btn btn-primary" target="_blank">Join Meeting</a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

{% else %}
    <!-- Display login form if the user is not authenticated -->
    <div class="col-md-6 offset-md-3">
        <br>
        <h2>Login</h2>
        <br>
        <form method="POST" action="{% url 'login' %}">
            {% csrf_token %}
            <div class="form-group">
                <label for="username">Username:</label>
                <input type="text" class="form-control" id="username" name="username" required>
            </div>
            <br>
            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" class="form-control" id="password" name="password" required>
            </div>
            <br>
            <button type="submit" class="btn btn-primary">Login</button>
            <br><br/>
            <p><a href="{% url 'password_reset' %}">Forgot your password?</a></p>
        </form>
    </div>
{% endif %}
{% endblock %}

{% block extra_css %}
<!-- CSS for animations and better UI -->
<style>
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .card, .list-group-item {
        animation: fadeIn 0.5s ease-in-out;
        opacity: 0;
        transform: translateY(10px);
    }

    .card.visible, .list-group-item.visible {
        opacity: 1;
        transform: translateY(0);
    }

    .interactive-card:hover {
        transform: scale(1.05);
        transition: transform 0.2s ease-in-out;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); /* Add shadow on hover */
    }

    .dashboard-heading {
        font-size: 2.5rem;
        font-weight: bold;
    }

    .dashboard-title {
        font-size: 1.5rem;
        font-weight: bold;
    }

    .dashboard-text {
        font-size: 1.25rem;
        font-weight: bold;
    }

    .dashboard-metric {
        font-size: 3rem;
        font-weight: bold;
    }

    .card-title {
        font-weight: bold;
    }

    .card-text {
        font-size: 2.5rem;
        color: #333;
        font-weight: bold;
    }

    .badge {
        font-size: 1.2rem;
        font-weight: bold;
    }

    .modal-header, .modal-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .btn-primary, .btn-outline-primary {
        transition: background-color 0.3s, color 0.3s;
    }

    .btn-primary:hover, .btn-outline-primary:hover {
        background-color: #0056b3;
        color: #fff;
    }

    /* Light background colors for cards */
    .card-highlight {
        background-color: #b2ebf2 !important; /* Darker cyan background */
        border: 5px solid #00796b; /* Thicker dark teal border */
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); /* Subtle shadow for highlights */
    }

    .card-gradient-leads {
        background-color: #aed581 !important; /* Darker green background */
        border: 5px solid #388e3c; /* Thicker dark green border */
        box-shadow: 0 4px 15px rgba(0, 100, 0, 0.2); /* Dark green shadow */
    }

    .card-gradient-clients {
        background-color: #64b5f6 !important; /* Darker blue background */
        border: 5px solid #1e88e5; /* Thicker dark blue border */
        box-shadow: 0 4px 15px rgba(30, 136, 229, 0.2); /* Blue shadow */
    }

    .card-gradient-tickets {
        background-color: #ffd54f !important; /* Darker yellow background */
        border: 5px solid #f57c00; /* Thicker dark orange border */
        box-shadow: 0 4px 15px rgba(255, 165, 0, 0.2); /* Orange shadow */
    }

    .card-gradient-overdues {
        background-color: #ef9a9a !important; /* Darker red background */
        border: 5px solid #c62828; /* Thicker dark red border */
        box-shadow: 0 4px 15px rgba(198, 40, 40, 0.2); /* Red shadow */
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- Include FontAwesome for icons -->
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Include Animate.css for animations -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

<!-- JavaScript for animations and charts -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Function to open modal with meeting details
        function openModal(clientName, link) {
            document.getElementById('meetingDetails').innerText = 'Meeting with ' + clientName;
            document.getElementById('meetingLink').href = link;
            var myModal = new bootstrap.Modal(document.getElementById('meetingModal'));
            myModal.show();
        }

        // Function to check if an element is in the viewport
        function isInViewport(element) {
            const rect = element.getBoundingClientRect();
            return (
                rect.top >= 0 &&
                rect.left >= 0 &&
                rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
                rect.right <= (window.innerWidth || document.documentElement.clientWidth)
            );
        }

        // Add a class for animation when elements are in the viewport
        function animateOnScroll() {
            const elements = document.querySelectorAll('.card, .list-group-item');
            elements.forEach(element => {
                if (isInViewport(element)) {
                    element.classList.add('visible');
                }
            });
        }

        // Add event listener for scrolling
        window.addEventListener('scroll', animateOnScroll);

        // Initial check in case elements are already in the viewport
        animateOnScroll();

        // Chart.js for Key Metrics
        const ctxLeads = document.getElementById('leadsChart').getContext('2d');
        const ctxClients = document.getElementById('clientsChart').getContext('2d');
        const ctxTickets = document.getElementById('ticketsChart').getContext('2d');
        const ctxDeals = document.getElementById('dealsChart').getContext('2d');

        new Chart(ctxLeads, {
            type: 'doughnut',
            data: {
                labels: ['Leads'],
                datasets: [{
                    data: [{{ total_leads }}, 100 - {{ total_leads }}],
                    backgroundColor: ['#388e3c', '#444444'], // Darker green and dark gray
                    hoverBackgroundColor: ['#2e7d32', '#333333'] // Even darker shades
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });

        new Chart(ctxClients, {
            type: 'doughnut',
            data: {
                labels: ['Clients'],
                datasets: [{
                    data: [{{ total_clients }}, 100 - {{ total_clients }}],
                    backgroundColor: ['#1976d2', '#444444'], // Darker blue and dark gray
                    hoverBackgroundColor: ['#1565c0', '#333333'] // Even darker shades
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });

        new Chart(ctxTickets, {
            type: 'doughnut',
            data: {
                labels: ['Open Tickets'],
                datasets: [{
                    data: [{{ open_tickets }}, 100 - {{ open_tickets }}],
                    backgroundColor: ['#f57c00', '#444444'], // Darker orange and dark gray
                    hoverBackgroundColor: ['#e65100', '#333333'] // Even darker shades
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });

        new Chart(ctxDeals, {
            type: 'doughnut',
            data: {
                labels: ['Over Dues'],
                datasets: [{
                    data: [{{ closed_deals }}, 100 - {{ closed_deals }}],
                    backgroundColor: ['#d32f2f', '#444444'], // Darker red and dark gray
                    hoverBackgroundColor: ['#c62828', '#333333'] // Even darker shades
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });

        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });

    });
</script>
{% endblock %}
